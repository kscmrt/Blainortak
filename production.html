<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Üretim Takibi - Blain Hydraulics</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script>
        document.documentElement.classList.add('sidebar-collapsed');
    </script>
    <style>
        .kanban-board {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            height: calc(100vh - 180px);
            /* Fill remaining height */
        }

        .kanban-column {
            flex: 1;
            min-width: 300px;
            background-color: var(--muted);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .column-header {
            padding: 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--background);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .column-header .count {
            background-color: var(--secondary);
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem;
        }

        .column-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .kanban-card {
            background-color: var(--card);
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
        }

        .card-info {
            font-size: 0.85rem;
            color: var(--muted-foreground);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Drag and Drop styles (simple visual cues) */
        .kanban-column.drag-over {
            background-color: #e2e8f0;
        }

        .kanban-card.dragging {
            opacity: 0.5;
        }

        /* New styles for inline replacements */
        .status-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--muted-foreground);
        }

        .status-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .priority-dot.priority-normal {
            background: #10b981;
        }

        .priority-dot.priority-urgent {
            background: #f59e0b;
        }

        .column-header-icon {
            margin-right: 6px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo.png" alt="Blain" class="sidebar-logo-img">
                    <h2>Blain Türkiye</h2>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <p class="nav-label">Ana Menü</p>
                    <a href="index.html" class="nav-item">
                        <i class="ri-add-circle-line icon"></i>
                        <span>Yeni Proje</span>
                    </a>
                    <a href="all-projects.html" class="nav-item">
                        <i class="ri-folder-line icon"></i>
                        <span>Tüm Projeler</span>
                    </a>
                    <button class="nav-item active">
                        <i class="ri-hammer-line icon"></i>
                        <span>Üretim Takibi</span>
                    </button>
                    <a href="summary_report.html" class="nav-item">
                        <i class="ri-file-chart-line icon"></i>
                        <span>İhtiyaç Raporu</span>
                    </a>
                </div>

                <div class="nav-group">
                    <p class="nav-label">Yönetim</p>
                    <a href="admin.html" id="adminPanelBtn" class="nav-item">
                        <i class="ri-admin-line icon"></i>
                        <span>Admin Paneli</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="nav-item logout">
                    <i class="ri-logout-box-line icon"></i>
                    <span>Çıkış Yap</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <h1 id="pageTitle">Üretim Takibi</h1>
                </div>
                <div class="header-right">
                    <div class="status-legend">
                        <span class="status-legend-item"><span class="priority-dot priority-normal"></span>
                            Normal</span>
                        <span class="status-legend-item"><span class="priority-dot priority-urgent"></span> Acil</span>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="kanban-board">
                    <!-- İmalat Column -->
                    <div class="kanban-column" id="col-imalat" ondrop="drop(event, 'imalat')"
                        ondragover="allowDrop(event)">
                        <div class="column-header">
                            <span><i class="ri-hammer-line column-header-icon"></i>İmalat</span>
                            <span class="count" id="count-imalat">0</span>
                        </div>
                        <div class="column-body" id="list-imalat">
                            <!-- Cards go here -->
                        </div>
                    </div>

                    <!-- Test Column -->
                    <div class="kanban-column" id="col-test" ondrop="drop(event, 'test')" ondragover="allowDrop(event)">
                        <div class="column-header">
                            <span><i class="ri-test-tube-line column-header-icon"></i>Test</span>
                            <span class="count" id="count-test">0</span>
                        </div>
                        <div class="column-body" id="list-test">
                        </div>
                    </div>

                    <!-- Paketleme Column -->
                    <div class="kanban-column" id="col-paketleme" ondrop="drop(event, 'paketleme')"
                        ondragover="allowDrop(event)">
                        <div class="column-header">
                            <span><i class="ri-box-3-line column-header-icon"></i>Paketleme</span>
                            <span class="count" id="count-paketleme">0</span>
                        </div>
                        <div class="column-body" id="list-paketleme">
                        </div>
                    </div>

                    <!-- Sevkedildi Column -->
                    <div class="kanban-column" id="col-sevkedildi" ondrop="drop(event, 'sevkedildi')"
                        ondragover="allowDrop(event)">
                        <div class="column-header">
                            <span><i class="ri-truck-line column-header-icon"></i>Sevkedildi</span>
                            <span class="count" id="count-sevkedildi">0</span>
                        </div>
                        <div class="column-body" id="list-sevkedildi">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Proje Detayları</h3>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalDetailsContent">
                <!-- Details injected here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailsModal()">Kapat</button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="auth.js"></script>
    <script src="sidebar.js"></script>
    <script src="data.js"></script>
    <script>
        // Check Auth
        if (!Auth.checkAuth()) {
            window.location.href = 'login.html';
        }

        document.getElementById('logoutBtn').addEventListener('click', () => { // Fixed logout handler
            Auth.logout();
        });

        // Initialize Kanban
        document.addEventListener('DOMContentLoaded', loadKanban);

        async function loadKanban() {
            // Clear lists first
            ['imalat', 'test', 'paketleme', 'sevkedildi'].forEach(status => {
                document.getElementById(`list-${status}`).innerHTML = '<div class="text-muted text-sm p-2 text-center">Yükleniyor...</div>';
                document.getElementById(`count-${status}`).textContent = '-';
            });

            try {
                const projects = await db.projects.getAll();

                // Clear lists again for content
                ['imalat', 'test', 'paketleme', 'sevkedildi'].forEach(status => {
                    document.getElementById(`list-${status}`).innerHTML = '';
                    document.getElementById(`count-${status}`).textContent = '0';
                });

                const counts = { imalat: 0, test: 0, paketleme: 0, sevkedildi: 0 };

                projects.forEach(project => {
                    if (project.status !== 'production') return;

                    const stage = project.production_stage || 'imalat';
                    if (!counts.hasOwnProperty(stage)) return; // Safety

                    counts[stage]++;
                    const card = createCard(project);
                    document.getElementById(`list-${stage}`).appendChild(card);
                });

                // Update counts
                Object.keys(counts).forEach(key => {
                    document.getElementById(`count-${key}`).textContent = counts[key];
                });

            } catch (e) {
                console.error(e);
                ['imalat', 'test', 'paketleme', 'sevkedildi'].forEach(status => {
                    document.getElementById(`list-${status}`).innerHTML = `<div class="text-danger p-2 text-center">Hata: ${e.message}</div>`;
                });
            }
        }

        function createCard(project) {
            const div = document.createElement('div');
            div.className = 'kanban-card';
            div.draggable = true;
            div.ondragstart = (e) => drag(e, project.project_number);
            div.onclick = () => showDetails(project);

            const date = new Date(project.created_at).toLocaleDateString('tr-TR');
            const cylInfo = project.selected_cylinder ? `${project.inputs.cylinderCount}x ${project.selected_cylinder}` : '-';

            div.innerHTML = `
                <div class="card-title">
                    <span>${project.customer_name}</span>
                    <span style="font-size: 0.8rem; color: var(--muted-foreground);">#${project.project_number}</span>
                </div>
                <div class="card-info">
                    <i class="ri-calendar-line"></i> ${date}
                </div>
                <div class="card-info">
                    <i class="ri-list-settings-line"></i> ${cylInfo}
                </div>
                <div class="card-footer">
                    <span class="text-xs text-muted">${project.created_by || 'Unknown'}</span>
                    <i class="ri-more-fill text-muted"></i>
                </div>
            `;
            return div;
        }

        // Drag & Drop Functions
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drag(ev, projectNumber) {
            ev.dataTransfer.setData("text", projectNumber);
            ev.target.classList.add('dragging');
        }

        function drop(ev, newStage) {
            ev.preventDefault();
            const col = ev.currentTarget;
            col.classList.remove('drag-over');

            const projectNumber = ev.dataTransfer.getData("text");
            updateProjectStage(projectNumber, newStage);
        }

        // Remove drag-over styling if drag leaves
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
        });

        async function updateProjectStage(projectNumber, newStage) {
            try {
                // Find ID first
                const projects = await db.projects.getAll();
                const project = projects.find(p => p.project_number === projectNumber);

                if (!project) return;

                // Optimistic Update (Immediate UI Refresh)
                // We'll trust fetch, but to be safe we just reloadKanban after await. 
                // Wait, refreshing whole board might be jarring. 
                // Let's just update DB then reload to be consistent.

                const oldStage = project.production_stage || 'imalat';

                await db.projects.update(projectNumber, { production_stage: newStage });

                // Log the movement
                await db.production.addLog({
                    project_number: projectNumber,
                    previous_stage: capitalize(oldStage),
                    new_stage: capitalize(newStage),
                    changed_by: Auth.getCurrentUser()?.username || 'admin',
                    notes: 'Sürükle bırak ile taşındı'
                });

                loadKanban(); // Refresh UI
            } catch (e) {
                console.error("Stage update failed", e);
                alert("Güncelleme başarısız: " + e.message);
                loadKanban(); // Revert UI
            }
        }

        function showDetails(project) {
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalDetailsContent');

            // Build simple detail view
            content.innerHTML = `
                 <div class="tabs mb-4" style="display: flex; gap: 1rem; border-bottom: 1px solid #e2e8f0;">
                    <button class="tab-btn active" onclick="switchTab('info')" style="padding: 0.5rem 1rem; border-bottom: 2px solid var(--primary); font-weight: 500;">Bilgiler</button>
                    <button class="tab-btn" onclick="switchTab('history')" style="padding: 0.5rem 1rem; color: var(--muted-foreground);">Geçmiş</button>
                </div>

                <div id="tab-info">
                    <div class="grid gap-4">
                        <div class="p-3 bg-slate-50 rounded border">
                            <strong>Müşteri:</strong> ${project.customer_name}<br>
                            <strong>Proje No:</strong> ${project.project_number}
                        </div>
                        <div>
                            <strong>Bileşenler:</strong>
                            <ul class="list-disc pl-5 mt-2">
                                <li>Silindir: ${project.selected_cylinder || '-'} (${project.inputs.cylinderCount} adet)</li>
                                <li>Motor: ${project.components?.motor || '-'}</li>
                                <li>Pompa: ${project.components?.pump || '-'}</li>
                                <li>Valf: ${project.components?.main_valve || project.components?.mainValve || '-'}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="tab-history" class="hidden">
                    <div class="space-y-4" id="historyList">
                        Yükleniyor...
                    </div>
                </div>
            `;

            // Load history
            loadProjectHistory(project.project_number);

            modal.classList.remove('hidden');
        }

        async function loadProjectHistory(projectNumber) {
            try {
                const logs = await db.production.getLogs(projectNumber);
                const list = document.getElementById('historyList');

                if (logs.length === 0) {
                    list.innerHTML = '<p class="text-muted text-sm">Henüz kayıt yok.</p>';
                    return;
                }

                list.innerHTML = logs.map(log => `
                    <div style="padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600;">${log.previous_stage || '-'} &rarr; ${log.new_stage}</span>
                            <span class="text-muted">${new Date(log.created_at).toLocaleDateString('tr-TR')} ${new Date(log.created_at).toLocaleTimeString('tr-TR').slice(0, 5)}</span>
                        </div>
                        <div class="text-sm text-secondary">
                            <i class="ri-user-line" style="font-size: 14px; margin-right: 4px;"></i> ${log.changed_by || 'Bilinmiyor'}
                        </div>
                        ${log.notes ? `<div class="text-xs text-muted mt-1 italic">${log.notes}</div>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('historyList').innerHTML = `<p class="text-danger">Geçmiş yüklenemedi: ${e.message}</p>`;
            }
        }

        function switchTab(tabName) {
            const infoTab = document.getElementById('tab-info');
            const historyTab = document.getElementById('tab-history');
            const btns = document.querySelectorAll('.tab-btn');

            if (tabName === 'info') {
                infoTab.classList.remove('hidden');
                historyTab.classList.add('hidden');
                btns[0].style.borderBottom = '2px solid var(--primary)';
                btns[0].style.color = 'black';
                btns[0].style.fontWeight = '500';
                btns[1].style.borderBottom = 'none';
                btns[1].style.color = 'var(--muted-foreground)';
                btns[1].style.fontWeight = 'normal';
            } else {
                infoTab.classList.add('hidden');
                historyTab.classList.remove('hidden');
                btns[1].style.borderBottom = '2px solid var(--primary)';
                btns[1].style.color = 'black';
                btns[1].style.fontWeight = '500';
                btns[0].style.borderBottom = 'none';
                btns[0].style.color = 'var(--muted-foreground)';
                btns[0].style.fontWeight = 'normal';
            }
        }

        function capitalize(s) {
            if (typeof s !== 'string') return '';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }
    </script>
</body>

</html>